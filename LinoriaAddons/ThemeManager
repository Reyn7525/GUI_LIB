local httpService = game:GetService('HttpService')
local ThemeManager = {} do
	ThemeManager.Folder = 'RenHub'
	-- if not isfolder(ThemeManager.Folder) then makefolder(ThemeManager.Folder) end

	ThemeManager.Library = nil
	ThemeManager.BuiltInThemes = {
		['Default'] 		= { 1, httpService:JSONDecode('{"FontColor":"ffffff","FontColorTransparency":0,"MainColor":"1c1c1c","MainColorTransparency":0,"AccentColor":"0055ff","AccentColorTransparency":0,"BackgroundColor":"141414","BackgroundColorTransparency":0,"OutlineColor":"#1f1f1f","OutlineColorTransparency":0}') },
		['BBot'] 			= { 2, httpService:JSONDecode('{"FontColor":"ffffff","FontColorTransparency":0,"MainColor":"1e1e1e","MainColorTransparency":0,"AccentColor":"7e48a3","AccentColorTransparency":0,"BackgroundColor":"232323","BackgroundColorTransparency":0,"OutlineColor":"141414","OutlineColorTransparency":0}') },
		['Fatality']		= { 3, httpService:JSONDecode('{"FontColor":"ffffff","FontColorTransparency":0,"MainColor":"1e1842","MainColorTransparency":0,"AccentColor":"c50754","AccentColorTransparency":0,"BackgroundColor":"191335","BackgroundColorTransparency":0,"OutlineColor":"#242039","OutlineColorTransparency":0}') },
		['Jester'] 			= { 4, httpService:JSONDecode('{"FontColor":"ffffff","FontColorTransparency":0,"MainColor":"242424","MainColorTransparency":0,"AccentColor":"db4467","AccentColorTransparency":0,"BackgroundColor":"1c1c1c","BackgroundColorTransparency":0,"OutlineColor":"373737","OutlineColorTransparency":0}') },
		['Mint'] 			= { 5, httpService:JSONDecode('{"FontColor":"ffffff","FontColorTransparency":0,"MainColor":"242424","MainColorTransparency":0,"AccentColor":"3db488","AccentColorTransparency":0,"BackgroundColor":"1c1c1c","BackgroundColorTransparency":0,"OutlineColor":"373737","OutlineColorTransparency":0}') },
		['Tokyo Night'] 	= { 6, httpService:JSONDecode('{"FontColor":"ffffff","FontColorTransparency":0,"MainColor":"191925","MainColorTransparency":0,"AccentColor":"6759b3","AccentColorTransparency":0,"BackgroundColor":"16161f","BackgroundColorTransparency":0,"OutlineColor":"323232","OutlineColorTransparency":0}') },
		['Ubuntu'] 			= { 7, httpService:JSONDecode('{"FontColor":"ffffff","FontColorTransparency":0,"MainColor":"3e3e3e","MainColorTransparency":0,"AccentColor":"e2581e","AccentColorTransparency":0,"BackgroundColor":"323232","BackgroundColorTransparency":0,"OutlineColor":"191919","OutlineColorTransparency":0}') },
		['Quartz'] 			= { 8, httpService:JSONDecode('{"FontColor":"ffffff","FontColorTransparency":0,"MainColor":"232330","MainColorTransparency":0,"AccentColor":"426e87","AccentColorTransparency":0,"BackgroundColor":"1d1b26","BackgroundColorTransparency":0,"OutlineColor":"27232f","OutlineColorTransparency":0}') },
	}

	function ThemeManager:ApplyTheme(theme)
		local customThemeData = self:GetCustomTheme(theme)
		local data = customThemeData or self.BuiltInThemes[theme]

		if not data then return end

		-- custom themes are just regular dictionaries instead of an array with { index, dictionary }

		local scheme = data[2]
		local themeData = customThemeData or scheme
		local colorFields = { "FontColor", "MainColor", "AccentColor", "BackgroundColor", "OutlineColor" }
		
		for _, field in next, colorFields do
			if themeData[field] then
				local transparencyField = field .. "Transparency"
				local transparency = themeData[transparencyField] or 0
				
				self.Library[field] = Color3.fromHex(themeData[field])
				
				if Options[field] then
					Options[field]:SetValueRGB(Color3.fromHex(themeData[field]), transparency)
				end
			end
		end

		self:ThemeUpdate()
	end

	function ThemeManager:ApplyTransparencyToRegistry()
		if not self.Library or not self.Library.ScreenGui then return end
		
		local transparencyMap = {
			FontColor = "FontColorTransparency",
			MainColor = "MainColorTransparency",
			AccentColor = "AccentColorTransparency",
			BackgroundColor = "BackgroundColorTransparency",
			OutlineColor = "OutlineColorTransparency"
		}
		
		for colorField, transparencyField in next, transparencyMap do
			if Options and Options[colorField] then
				self.Library[transparencyField] = Options[colorField].Transparency or 0
			end
		end
		
		local fontTransparency = self.Library.FontColorTransparency or 0
		local mainTransparency = self.Library.MainColorTransparency or 0
		local accentTransparency = self.Library.AccentColorTransparency or 0
		local backgroundTransparency = self.Library.BackgroundColorTransparency or 0
		local outlineTransparency = self.Library.OutlineColorTransparency or 0
		
		for _, Object in next, self.Library.Registry or {} do
			if Object.Instance and Object.Instance.Parent then
				for Property, ColorIdx in next, Object.Properties do
					if type(ColorIdx) == 'string' then
						local transparency = 0
						if ColorIdx == "FontColor" then
							transparency = fontTransparency
						elseif ColorIdx == "MainColor" then
							transparency = mainTransparency
						elseif ColorIdx == "AccentColor" then
							transparency = accentTransparency
						elseif ColorIdx == "BackgroundColor" then
							transparency = backgroundTransparency
						elseif ColorIdx == "OutlineColor" then
							transparency = outlineTransparency
						end
						
						if Property == "BackgroundColor3" and Object.Instance:IsA("GuiObject") then
							pcall(function()
								Object.Instance.BackgroundTransparency = transparency
							end)
						elseif Property == "TextColor3" and (Object.Instance:IsA("TextLabel") or Object.Instance:IsA("TextButton") or Object.Instance:IsA("TextBox")) then
							pcall(function()
								Object.Instance.TextTransparency = transparency
							end)
						elseif Property == "BorderColor3" and Object.Instance:IsA("GuiObject") then
							pcall(function()
								Object.Instance.BorderTransparency = transparency
							end)
						elseif Property == "ImageColor3" and Object.Instance:IsA("ImageLabel") then
							pcall(function()
								Object.Instance.ImageTransparency = transparency
							end)
						end
					end
				end
			end
		end
		
		local function colorsEqual(c1, c2)
			if not c1 or not c2 then return false end
			return math.abs(c1.R - c2.R) < 0.01 and math.abs(c1.G - c2.G) < 0.01 and math.abs(c1.B - c2.B) < 0.01
		end
		
		for _, desc in next, self.Library.ScreenGui:GetDescendants() do
			if desc:IsA("Frame") or desc:IsA("ScrollingFrame") then
				if colorsEqual(desc.BackgroundColor3, self.Library.BackgroundColor) then
					pcall(function() desc.BackgroundTransparency = backgroundTransparency end)
				elseif colorsEqual(desc.BackgroundColor3, self.Library.MainColor) then
					pcall(function() desc.BackgroundTransparency = mainTransparency end)
				elseif colorsEqual(desc.BackgroundColor3, self.Library.AccentColor) then
					pcall(function() desc.BackgroundTransparency = accentTransparency end)
				end
			elseif desc:IsA("TextLabel") or desc:IsA("TextButton") or desc:IsA("TextBox") then
				if colorsEqual(desc.TextColor3, self.Library.FontColor) then
					pcall(function() desc.TextTransparency = fontTransparency end)
				end
			elseif desc:IsA("UIStroke") then
				if colorsEqual(desc.Color, self.Library.OutlineColor) then
					pcall(function() desc.Transparency = outlineTransparency end)
				end
			end
		end
	end

	function ThemeManager:ThemeUpdate()
		-- This allows us to force apply themes without loading the themes tab :)
		local options = { "FontColor", "MainColor", "AccentColor", "BackgroundColor", "OutlineColor" }
		for i, field in next, options do
			if Options and Options[field] then
				self.Library[field] = Options[field].Value
			end
		end

		self.Library.AccentColorDark = self.Library:GetDarkerColor(self.Library.AccentColor);
		self.Library:UpdateColorsUsingRegistry()
		self:ApplyTransparencyToRegistry()
	end

	function ThemeManager:LoadDefault()		
		local theme = 'Default'
		local content = isfile(self.Folder .. '/themes/default.txt') and readfile(self.Folder .. '/themes/default.txt')

		local isDefault = true
		if content then
			if self.BuiltInThemes[content] then
				theme = content
			elseif self:GetCustomTheme(content) then
				theme = content
				isDefault = false;
			end
		elseif self.BuiltInThemes[self.DefaultTheme] then
		 	theme = self.DefaultTheme
		end

		if isDefault then
			Options.ThemeManager_ThemeList:SetValue(theme)
		else
			self:ApplyTheme(theme)
		end
	end

	function ThemeManager:SaveDefault(theme)
		writefile(self.Folder .. '/themes/default.txt', theme)
	end

	function ThemeManager:CreateThemeManager(groupbox)
		groupbox:AddLabel('Background color'):AddColorPicker('BackgroundColor', { Default = self.Library.BackgroundColor, Transparency = 0 });
		groupbox:AddLabel('Main color')	:AddColorPicker('MainColor', { Default = self.Library.MainColor, Transparency = 0 });
		groupbox:AddLabel('Accent color'):AddColorPicker('AccentColor', { Default = self.Library.AccentColor, Transparency = 0 });
		groupbox:AddLabel('Outline color'):AddColorPicker('OutlineColor', { Default = self.Library.OutlineColor, Transparency = 0 });
		groupbox:AddLabel('Font color')	:AddColorPicker('FontColor', { Default = self.Library.FontColor, Transparency = 0 });

		local ThemesArray = {}
		for Name, Theme in next, self.BuiltInThemes do
			table.insert(ThemesArray, Name)
		end

		table.sort(ThemesArray, function(a, b) return self.BuiltInThemes[a][1] < self.BuiltInThemes[b][1] end)

		groupbox:AddDivider()
		groupbox:AddDropdown('ThemeManager_ThemeList', { Text = 'Theme list', Values = ThemesArray, Default = 1 })

		groupbox:AddButton('Set as default', function()
			self:SaveDefault(Options.ThemeManager_ThemeList.Value)
			self.Library:Notify(string.format('Set default theme to %q', Options.ThemeManager_ThemeList.Value))
		end)

		Options.ThemeManager_ThemeList:OnChanged(function()
			self:ApplyTheme(Options.ThemeManager_ThemeList.Value)
		end)

		groupbox:AddDivider()
		groupbox:AddInput('ThemeManager_CustomThemeName', { Text = 'Custom theme name' })
		groupbox:AddDropdown('ThemeManager_CustomThemeList', { Text = 'Custom themes', Values = self:ReloadCustomThemes(), AllowNull = true, Default = 1 })
		groupbox:AddDivider()
		
		groupbox:AddButton('Save theme', function() 
			self:SaveCustomTheme(Options.ThemeManager_CustomThemeName.Value)

			Options.ThemeManager_CustomThemeList:SetValues(self:ReloadCustomThemes())
			Options.ThemeManager_CustomThemeList:SetValue(nil)
		end):AddButton('Load theme', function() 
			self:ApplyTheme(Options.ThemeManager_CustomThemeList.Value) 
		end)

		groupbox:AddButton('Refresh list', function()
			Options.ThemeManager_CustomThemeList:SetValues(self:ReloadCustomThemes())
			Options.ThemeManager_CustomThemeList:SetValue(nil)
		end)

		groupbox:AddButton('Set as default', function()
			if Options.ThemeManager_CustomThemeList.Value ~= nil and Options.ThemeManager_CustomThemeList.Value ~= '' then
				self:SaveDefault(Options.ThemeManager_CustomThemeList.Value)
				self.Library:Notify(string.format('Set default theme to %q', Options.ThemeManager_CustomThemeList.Value))
			end
		end)

		ThemeManager:LoadDefault()

		local function UpdateTheme()
			self:ThemeUpdate()
		end

		for _, field in next, { "BackgroundColor", "MainColor", "AccentColor", "OutlineColor", "FontColor" } do
			if Options[field] then
				local lastTransparency = Options[field].Transparency or 0
				
				Options[field]:OnChanged(function()
					if Options[field] then
						self.Library[field] = Options[field].Value
					end
					
					local currentTransparency = Options[field].Transparency or 0
					lastTransparency = currentTransparency
					
					if field == "AccentColor" then
						self.Library.AccentColorDark = self.Library:GetDarkerColor(self.Library.AccentColor)
					end
					
					self.Library:UpdateColorsUsingRegistry()
					task.wait()
					self:ApplyTransparencyToRegistry()
				end)
				
				task.spawn(function()
					while self.Library and not self.Library.Unloaded do
						task.wait(0.05)
						if Options[field] then
							local currentTransparency = Options[field].Transparency or 0
							if math.abs(currentTransparency - lastTransparency) > 0.001 then
								lastTransparency = currentTransparency
								self:ApplyTransparencyToRegistry()
							end
						end
					end
				end)
			end
		end
	end

	function ThemeManager:GetCustomTheme(file)
		local path = self.Folder .. '/themes/' .. file
		if not isfile(path) then
			return nil
		end

		local data = readfile(path)
		local success, decoded = pcall(httpService.JSONDecode, httpService, data)
		
		if not success then
			return nil
		end

		return decoded
	end

	function ThemeManager:SaveCustomTheme(file)
		if file:gsub(' ', '') == '' then
			return self.Library:Notify('Invalid file name for theme (empty)', 3)
		end

		local theme = {}
		local fields = { "FontColor", "MainColor", "AccentColor", "BackgroundColor", "OutlineColor" }

		for _, field in next, fields do
			theme[field] = Options[field].Value:ToHex()
			theme[field .. "Transparency"] = Options[field].Transparency or 0
		end

		writefile(self.Folder .. '/themes/' .. file .. '.json', httpService:JSONEncode(theme))
	end

	function ThemeManager:ReloadCustomThemes()
		local list = listfiles(self.Folder .. '/themes')

		local out = {}
		for i = 1, #list do
			local file = list[i]
			if file:sub(-5) == '.json' then
				-- i hate this but it has to be done ...

				local pos = file:find('.json', 1, true)
				local char = file:sub(pos, pos)

				while char ~= '/' and char ~= '\\' and char ~= '' do
					pos = pos - 1
					char = file:sub(pos, pos)
				end

				if char == '/' or char == '\\' then
					table.insert(out, file:sub(pos + 1))
				end
			end
		end

		return out
	end

	function ThemeManager:SetLibrary(lib)
		self.Library = lib
	end

	function ThemeManager:BuildFolderTree()
		local paths = {}

		-- build the entire tree if a path is like some-hub/phantom-forces
		-- makefolder builds the entire tree on Synapse X but not other exploits

		local parts = self.Folder:split('/')
		for idx = 1, #parts do
			paths[#paths + 1] = table.concat(parts, '/', 1, idx)
		end

		table.insert(paths, self.Folder .. '/themes')
		table.insert(paths, self.Folder .. '/assets')

		for i = 1, #paths do
			local str = paths[i]
			if not isfolder(str) then
				makefolder(str)
			end
		end
	end

	function ThemeManager:SetFolder(folder)
		self.Folder = folder
		self:BuildFolderTree()
	end

	function ThemeManager:CreateGroupBox(tab)
		assert(self.Library, 'Must set ThemeManager.Library first!')
		return tab:AddLeftGroupbox('Themes')
	end

	function ThemeManager:ApplyToTab(tab)
		assert(self.Library, 'Must set ThemeManager.Library first!')
		local groupbox = self:CreateGroupBox(tab)
		self:CreateThemeManager(groupbox)
	end

	function ThemeManager:ApplyToGroupbox(groupbox)
		assert(self.Library, 'Must set ThemeManager.Library first!')
		self:CreateThemeManager(groupbox)
	end

	ThemeManager:BuildFolderTree()
end

return ThemeManager
